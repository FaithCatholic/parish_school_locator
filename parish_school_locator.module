<?php

/**
 * @file
 * Contains parish_school_locator.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_help().
 */
function parish_school_locator_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the parish_school_locator module.
    case 'help.page.parish_school_locator':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Find parishes and schools by address, name, and mass time') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_theme().
 */
function parish_school_locator_theme() {
  return [
    'parish_school_locator' => [
      'render element' => 'children',
    ],
  ];
}

/**
 * Implements hook_form_alter()
 */
function parish_school_locator_form_alter(&$form, FormStateInterface $form_state, $form_id) {

  // Parish finder exposed view form
  if ($form['#id'] == 'views-exposed-form-parish-finder-page-1') {

    // Hide distance filter
    $form['field_geolocation_proximity']['#type'] = 'hidden';

    // Hide mass start time filter so we can replace it with a select list
    $form['field_service_start_time_value']['#type'] = 'hidden';

    // Set select list time options to output of custom function
    $options = parish_school_locator_hms_selector();

    // Create custom field for selecting mass time
    $form['field_service_start_time_value_hms']['#title'] = t('Mass Time');
    $form['field_service_start_time_value_hms']['#type'] = 'select';
    $form['field_service_start_time_value_hms']['#options'] = $options;
    $form['field_service_start_time_value_hms']['#default_value'] = '';

    // Add custom submit handler to populate mass time filter with custom field selection
    $form['#validate'][] = 'parish_school_locator_custom_validate';
  }
}

function parish_school_locator_hms_selector() {
  $times = \Drupal::database();
  $query = $times->query("SELECT DISTINCT field_service_start_time_value FROM mass_times__field_service_start_time ORDER BY field_service_start_time_value");
  $results = $query->fetchCol();
  $output = array(
    '' => '- Any -'
  );
  foreach ($results as $record) {
    $label = gmdate('g:i a', (int)$record);
    $output[$record] = $label;
  }

  return $output;
}

function parish_school_locator_custom_validate(array $form, FormStateInterface $form_state) {
  $hms = $form_state->getValue('field_service_start_time_value_hms');
  $form_state->setValue('field_service_start_time_value', $hms);
}